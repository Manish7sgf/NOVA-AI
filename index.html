<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova AI - Next Gen Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root {
        --bg-deep: #0a0118;
        --bg-dark: #150828;
        --glass-bg: rgba(56, 29, 99, 0.08);
        --glass-strong: rgba(56, 29, 99, 0.18);
        --glass-elevated: rgba(56, 29, 99, 0.25);
        --accent-cyan: #00f5ff;
        --accent-magenta: #ff006e;
        --accent-purple: #8b5cf6;
        --accent-blue: #3b82f6;
        --text-primary: #ffffff;
        --text-secondary: #a5b4fc;
        --text-glow: #e0e7ff;
        --border-glow: rgba(0, 245, 255, 0.2);
        --border-subtle: rgba(139, 92, 246, 0.15);
        --shadow-glow: rgba(0, 245, 255, 0.3);
        --success-green: #10b981;
        --warning-amber: #f59e0b;
        --sidebar-width: 340px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', 'Space Grotesk', sans-serif;
        background: radial-gradient(ellipse at top left, #1a0b2e 0%, #0a0118 50%, #16001e 100%);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        position: relative;
    }

    body::before {
        content: '';
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        background-image:Â 
            linear-gradient(rgba(139, 92, 246, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(139, 92, 246, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: 0;
        animation: gridMove 20s linear infinite;
    }

    @keyframes gridMove {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
    }

    body::after {
        content: '';
        position: fixed;
        width: 200%;
        height: 200%;
        top: -50%;
        left: -50%;
        background:Â 
            radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(0, 245, 255, 0.12) 0%, transparent 50%),
            radial-gradient(circle at 40% 20%, rgba(255, 0, 110, 0.08) 0%, transparent 50%);
        animation: backgroundMove 25s ease-in-out infinite;
        z-index: 0;
    }

    @keyframes backgroundMove {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        33% { transform: translate(-5%, -5%) rotate(120deg); }
        66% { transform: translate(5%, 5%) rotate(240deg); }
    }

    .particle {
        position: fixed;
        width: 2px;
        height: 2px;
        background: var(--accent-cyan);
        border-radius: 50%;
        animation: float 20s infinite ease-in-out;
        opacity: 0.3;
        box-shadow: 0 0 8px var(--accent-cyan);
    }

    @keyframes float {
        0%, 100% {
            transform: translateY(0) translateX(0);
            opacity: 0;
        }
        10% { opacity: 0.3; }
        90% { opacity: 0.3; }
        100% {
            transform: translateY(-100vh) translateX(100px);
            opacity: 0;
        }
    }

    .app-container {
        display: flex;
        width: 100%;
        height: 100vh;
        position: relative;
        z-index: 1;
    }

    /* Auto-Hide Sidebar */
    .sidebar {
        width: var(--sidebar-width);
        background: var(--glass-bg);
        backdrop-filter: blur(40px) saturate(180%);
        border-right: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
        padding: 2rem 1.25rem;
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        overflow: hidden;
        box-shadow: inset -1px 0 0 rgba(255, 255, 255, 0.05);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
    }

    .sidebar.hidden {
        transform: translateX(calc(-1 * var(--sidebar-width) + 60px));
    }

    .sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, rgba(139, 92, 246, 0.06) 0%, transparent 100%);
        pointer-events: none;
    }

    .sidebar-hover-zone {
        position: fixed;
        left: 0;
        top: 0;
        width: 60px;
        height: 100vh;
        z-index: 99;
        pointer-events: auto;
    }

    .sidebar-header {
        margin-bottom: 1.75rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        z-index: 2;
    }

    .logo-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .logo-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 8px 20px rgba(0, 245, 255, 0.3);
        animation: iconPulse 3s ease-in-out infinite;
    }

    @keyframes iconPulse {
        0%, 100% { box-shadow: 0 8px 20px rgba(0, 245, 255, 0.3); }
        50% { box-shadow: 0 8px 30px rgba(255, 0, 110, 0.4); }
    }

    .logo {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.5px;
    }

    .sidebar-toggle {
        width: 32px;
        height: 32px;
        background: var(--glass-strong);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .sidebar-toggle:hover {
        background: var(--glass-elevated);
        border-color: var(--border-glow);
        transform: scale(1.05);
    }

    .new-chat-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        width: 100%;
        padding: 1rem 1.5rem;
        border: 1px solid var(--border-glow);
        background: linear-gradient(135deg, rgba(0, 245, 255, 0.15), rgba(139, 92, 246, 0.15));
        backdrop-filter: blur(20px);
        color: var(--text-primary);
        border-radius: 14px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 245, 255, 0.15);
    }

    .new-chat-btn::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transform: rotate(45deg);
        transition: all 0.6s;
    }

    .new-chat-btn:hover::before {
        left: 100%;
    }

    .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(0, 245, 255, 0.3);
        border-color: var(--accent-cyan);
    }

    .search-container {
        margin: 1.5rem 0;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.875rem 1rem 0.875rem 2.75rem;
        background: var(--glass-strong);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        color: var(--text-primary);
        font-size: 0.875rem;
        font-family: inherit;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--border-glow);
        background: var(--glass-elevated);
        box-shadow: 0 4px 16px rgba(0, 245, 255, 0.15);
    }

    .search-input::placeholder {
        color: var(--text-secondary);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        pointer-events: none;
    }

    .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        position: relative;
        z-index: 2;
        margin-right: -0.5rem;
        padding-right: 0.75rem;
    }

    .sidebar-content::-webkit-scrollbar {
        width: 4px;
    }

    .sidebar-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, var(--accent-cyan), var(--accent-purple));
        border-radius: 10px;
    }

    .chat-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .chat-tab {
        flex: 1;
        padding: 0.625rem;
        background: transparent;
        border: 1px solid var(--border-subtle);
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chat-tab.active {
        background: var(--glass-strong);
        border-color: var(--border-glow);
        color: var(--accent-cyan);
        box-shadow: 0 0 20px rgba(0, 245, 255, 0.2);
    }

    .chat-history {
        margin-top: 0.5rem;
    }

    .chat-history p {
        color: var(--text-secondary);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 700;
        margin-bottom: 1rem;
        padding-left: 0.5rem;
    }

    .chat-history ul {
        list-style: none;
    }

    .chat-history li {
        margin-bottom: 0.5rem;
    }

    .chat-history li a {
        color: var(--text-glow);
        text-decoration: none;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.875rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        position: relative;
    }

    .chat-history li a::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: linear-gradient(to bottom, var(--accent-cyan), var(--accent-magenta));
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .chat-history li a:hover {
        background: var(--glass-strong);
        border-color: var(--border-subtle);
        transform: translateX(4px);
    }

    .chat-history li a:hover::before {
        transform: scaleY(1);
    }

    .sidebar-footer {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding-top: 1.25rem;
        border-top: 1px solid var(--border-subtle);
        position: relative;
        z-index: 2;
    }

    .sidebar-footer a {
        color: var(--text-glow);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 0.75rem 0.875rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        border: 1px solid transparent;
    }

    .sidebar-footer a:hover {
        background: var(--glass-strong);
        border-color: var(--border-subtle);
        transform: translateX(4px);
    }

    /* Main Content */
    .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin-left: var(--sidebar-width);
        transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .main-content.expanded {
        margin-left: 60px;
    }

    .main-header {
        padding: 1.25rem 2.5rem;
        background: linear-gradient(to right, rgba(21, 8, 40, 0.8), rgba(21, 8, 40, 0.5));
        backdrop-filter: blur(40px) saturate(180%);
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.05), 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .menu-toggle {
        width: 40px;
        height: 40px;
        background: var(--glass-strong);
        border: 1px solid var(--border-subtle);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .menu-toggle:hover {
        background: var(--glass-elevated);
        border-color: var(--border-glow);
        transform: scale(1.05);
    }

    /* */
    .model-selector {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 1.25rem;
        background: var(--glass-strong);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .model-selector:hover {
        border-color: var(--border-glow);
        box-shadow: 0 4px 16px rgba(0, 245, 255, 0.15);
    }

    .model-badge {
        padding: 0.25rem 0.625rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-pro { background: linear-gradient(135deg, #f6d365, #fda085); }
    .badge-flash { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); }
    .badge-lite { background: linear-gradient(135deg, #56ab2f, #a8e063); }
    .badge-img { background: linear-gradient(135deg, #ff006e, #ff5e62); }
    .badge-live { background: linear-gradient(135deg, #2196f3, #f44336); }
    .badge-audio { background: linear-gradient(135deg, #9b59b6, #e74c3c); }


    .model-name {
        font-size: 0.875rem;
        font-weight: 600;
    }

    .model-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 10px);
        left: 0;
        width: 300px;
        background: var(--glass-elevated);
        backdrop-filter: blur(30px);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        z-index: 100;
        overflow: hidden;
    }

    .model-dropdown.visible {
        display: block;
    }

    .model-option {
        padding: 1rem 1.25rem;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid var(--border-subtle);
    }

    .model-option:last-child {
        border-bottom: none;
    }

    .model-option:hover {
        background: var(--glass-strong);
    }

    .model-option-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .model-option p {
        font-size: 0.8rem;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 0.625rem 1.125rem;
        background: var(--glass-strong);
        backdrop-filter: blur(20px);
        border-radius: 50px;
        border: 1px solid var(--border-subtle);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .user-profile:hover {
        border-color: var(--border-glow);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 245, 255, 0.2);
    }

    .user-profile img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 2px solid var(--accent-cyan);
        box-shadow: 0 0 15px rgba(0, 245, 255, 0.4);
    }

    .user-info {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }

    .user-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-primary);
    }

    .user-status {
        font-size: 0.7rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .status-dot {
        width: 6px;
        height: 6px;
        background: var(--success-green);
        border-radius: 50%;
        animation: statusBlink 2s ease-in-out infinite;
        box-shadow: 0 0 8px var(--success-green);
    }

    @keyframes statusBlink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .chat-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 2.5rem;
        max-width: 1100px;
        width: 100%;
        margin: 0 auto;
    }

    .chat-container::-webkit-scrollbar {
        width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, var(--accent-cyan), var(--accent-purple));
        border-radius: 10px;
    }

    .chat-message {
        margin-bottom: 2rem;
        animation: messageFloat 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        animation-fill-mode: forwards;
    }

    @keyframes messageFloat {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.875rem;
        font-size: 0.9rem;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        box-shadow: 0 0 15px rgba(0, 245, 255, 0.4);
        flex-shrink: 0;
    }

    .message-name {
        flex: 1;
    }

    .message-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 400;
    }

    /* Action button container inside the message content */
    .message-actions-panel {
        position: absolute;
        bottom: 0.5rem; /* Distance from bottom edge */
        right: 0.5rem;  /* Distance from right edge */
        display: flex;
        gap: 0.375rem;
        padding: 0.5rem;
        border-radius: 12px;
        background: rgba(10, 1, 24, 0.5); /* Semi-transparent background for contrast */
        backdrop-filter: blur(8px);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* Ensure actions are visible on hover of the whole message */
    .chat-message:hover .message-actions-panel {
        opacity: 1;
    }

    /* Tweak individual action buttons for this placement */
    .message-actions-panel .action-btn {
        width: 24px; /* Slightly smaller buttons */
        height: 24px;
        background: none;
        border: none;
    }

    .message-actions-panel .action-btn:hover {
        background: var(--glass-strong);
        transform: none; /* Remove scale transform */
    }

    /* Remove old header action styles which are no longer needed */
    .message-actions { display: none; }


    .action-btn {
        width: 28px;
        height: 28px;
        background: var(--glass-strong);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-secondary);
    }

    .action-btn:hover {
        background: var(--glass-elevated);
        border-color: var(--border-glow);
        color: var(--accent-cyan);
        transform: scale(1.05);
    }
    .action-btn.active {
        color: var(--accent-cyan);
        border-color: var(--border-glow);
        background: var(--glass-elevated);
    }

    .message-content {
        line-height: 1.7;
        padding: 1.5rem;
        border-radius: 16px;
        background: var(--glass-strong);
        backdrop-filter: blur(30px);
        border: 1px solid var(--border-subtle);
        position: relative;
        overflow: hidden;
        font-size: 0.95rem;
    }
    .message-content p {
        margin-bottom: 1rem;
    }
    .message-content p:last-child {
        margin-bottom: 0;
    }
    .message-content ul, .message-content ol {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
    }
    .message-content li {
        margin-bottom: 0.5rem;
    }
    .message-content code:not(pre > code) {
        background: rgba(139, 92, 246, 0.2);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', Courier, monospace;
    }
    .message-content .code-block {
        position: relative;
        margin: 1rem 0;
    }
    .message-content pre {
        background: var(--bg-deep);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 1rem;
        padding-top: 3rem; /* Space for copy button */
        overflow-x: auto;
        font-size: 0.875rem;
        line-height: 1.5;
    }
    .message-content pre code {
        font-family: 'Courier New', Courier, monospace;
    }
    .copy-code-btn {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: var(--glass-strong);
        border: 1px solid var(--border-subtle);
        color: var(--text-secondary);
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.75rem;
    }
    .copy-code-btn:hover {
        background: var(--glass-elevated);
        color: var(--accent-cyan);
    }


    .user-message .message-content {
        background: linear-gradient(135deg, rgba(0, 245, 255, 0.12), rgba(139, 92, 246, 0.12));
        border-left: 3px solid var(--accent-cyan);
        box-shadow: 0 4px 20px rgba(0, 245, 255, 0.15);
    }

    .gemini-message .message-content {
        background: var(--glass-strong);
        border-left: 3px solid var(--accent-magenta);
        box-shadow: 0 4px 20px rgba(255, 0, 110, 0.15);
    }

    .welcome-message {
        text-align: center;
        padding: 5rem 2rem;
        animation: welcomeAppear 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes welcomeAppear {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
        }
    }

    .welcome-message h1 {
        font-size: 4rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta), var(--accent-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
        background-size: 200% 200%;
        animation: titleGradient 6s ease infinite;
        line-height: 1.1;
        letter-spacing: -2px;
    }

    @keyframes titleGradient {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    .welcome-message h2 {
        font-size: 1.5rem;
        font-weight: 400;
        color: var(--text-secondary);
        margin-bottom: 3rem;
        line-height: 1.5;
    }

    .suggestion-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        max-width: 900px;
        margin: 0 auto;
    }

    .suggestion-card:hover {
        background: var(--glass-elevated);
        border-color: var(--border-glow);
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(0, 245, 255, 0.2);
    }

    .suggestion-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
    }

    .suggestion-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .suggestion-desc {
        font-size: 0.875rem;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    .chat-footer {
        padding: 1.5rem 2.5rem;
        background: var(--glass-bg);
        backdrop-filter: blur(40px) saturate(180%);
        border-top: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .input-wrapper {
        width: 100%;
        max-width: 1100px;
        display: flex;
        flex-direction: column;
        gap: 0.875rem;
    }

    .input-container {
        display: flex;
        flex-direction: column; /* MUST be column to stack preview on top of the input row */
        align-items: flex-start; /* Aligns the preview to the left */
        width: 100%;
        background: var(--glass-strong);
        backdrop-filter: blur(30px);
        border-radius: 20px;
        border: 1px solid var(--border-subtle);
        /* Adjusted padding for cleaner layout with file preview container */
        padding: 0.75rem 0.75rem 0.75rem 1.25rem;
        transition: all 0.3s ease;
        gap: 0.75rem;
        position: relative;
    }

    .input-container:focus-within {
        border-color: var(--border-glow);
        box-shadow: 0 0 30px rgba(0, 245, 255, 0.15), 0 8px 24px rgba(0, 245, 255, 0.1);
    }

    .input-container textarea {
        flex-grow: 1;
        background: none;
        border: none;
        outline: none;
        color: var(--text-primary);
        font-size: 0.95rem;
        padding: 0.5rem 0; /* Padding restored to inner textarea */
        font-family: inherit;
        resize: none;
        max-height: 150px;
        line-height: 1.5;
    }

    .input-container textarea::placeholder {
        color: var(--text-secondary);
    }

    .input-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .icon-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 10px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .icon-btn:hover {
        background: var(--glass-elevated);
        color: var(--accent-cyan);
        transform: scale(1.05);
    }

    .send-btn {
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
        border: none;
        padding: 0.75rem;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 245, 255, 0.3);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .send-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 245, 255, 0.4);
    }

    .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .footer-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        max-width: 1100px;
        margin-top: 0.75rem;
    }

    .footer-note {
        font-size: 0.75rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .footer-stats {
        display: flex;
        gap: 1.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .footer-stats span {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .loading {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
    }

    .loading-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent-cyan);
        animation: loadingPulse 1.2s ease-in-out infinite;
    }

    .loading-dot:nth-child(1) {
        animation-delay: 0s;
        background: var(--accent-cyan);
    }
    .loading-dot:nth-child(2) {
        animation-delay: 0.2s;
        background: var(--accent-magenta);
    }
    .loading-dot:nth-child(3) {
        animation-delay: 0.4s;
        background: var(--accent-purple);
    }

    @keyframes loadingPulse {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1.2);
            opacity: 1;
        }
    }

    .icon {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none;
    }

    /* API Key Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 1, 24, 0.9);
        backdrop-filter: blur(10px);
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: var(--glass-elevated);
        backdrop-filter: blur(40px);
        border: 1px solid var(--border-glow);
        border-radius: 20px;
        padding: 2.5rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 245, 255, 0.3);
    }

    .modal-content h3 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.875rem;
        font-size: 0.9rem;
    }

    .modal-content p {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    .api-input {
        width: 100%;
        padding: 0.875rem 1rem;
        background: var(--glass-strong);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        color: var(--text-primary);
        font-size: 0.875rem;
        font-family: inherit;
        margin-bottom: 1rem;
    }

    .api-input:focus {
        outline: none;
        border-color: var(--border-glow);
        box-shadow: 0 0 20px rgba(0, 245, 255, 0.2);
    }

    .api-select {
        width: 100%;
        padding: 0.875rem 1rem;
        background: var(--glass-strong);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        color: var(--text-primary);
        font-size: 0.875rem;
        font-family: inherit;
        margin-bottom: 1.5rem;
        cursor: pointer;
    }

    .modal-buttons {
        display: flex;
        gap: 1rem;
    }

    .modal-btn {
        flex: 1;
        padding: 0.875rem;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .modal-btn-primary {
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
        color: white;
    }

    .modal-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 245, 255, 0.4);
    }

    .modal-btn-secondary {
        background: var(--glass-strong);
        border: 1px solid var(--border-subtle);
        color: var(--text-glow);
    }

    .error-message {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        color: #fca5a5;
        font-size: 0.875rem;
    }
    
    /* ------------------------------------------------------------------- */
    /* --- NEW/UPDATED STYLES FOR VOICE ANIMATION AND FILE PREVIEW --- */
    /* ------------------------------------------------------------------- */

    /* 1. HIDE THE NATIVE FILE INPUT UI (FIXED ISSUE) */
    #file-input {
        display: none; 
    }
    
    /* Base style for voice/send button icon color */
    .icon-btn.active svg,
    .voice-visualizer {
        color: var(--accent-magenta); 
    }

    /* Voice Mode Input Container Glow */
    .input-container.voice-active {
        border-color: var(--accent-magenta);
        box-shadow: 0 0 30px rgba(255, 0, 110, 0.25), 0 8px 24px rgba(255, 0, 110, 0.1);
    }

    /* Voice Visualizer Styles */
    .voice-visualizer {
        width: 100%;
        height: 40px; 
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 0.5rem 0;
    }

    .voice-bar {
        width: 3px;
        height: 5px;
        background-color: var(--accent-magenta);
        border-radius: 2px;
        animation: voice-pulse 1s ease-in-out infinite alternate;
        transform-origin: bottom;
    }

    .voice-bar:nth-child(1) { height: 10px; animation-delay: 0.2s; }
    .voice-bar:nth-child(2) { height: 15px; animation-delay: 0.0s; }
    .voice-bar:nth-child(3) { height: 8px; animation-delay: 0.4s; }
    .voice-bar:nth-child(4) { height: 18px; animation-delay: 0.1s; }
    .voice-bar:nth-child(5) { height: 12px; animation-delay: 0.3s; }
    .voice-bar:nth-child(6) { height: 6px; animation-delay: 0.5s; }
    .voice-bar:nth-child(7) { height: 14px; animation-delay: 0.15s; }

    @keyframes voice-pulse {
        0% { transform: scaleY(0.5); opacity: 0.7; }
        100% { transform: scaleY(1.5); opacity: 1; }
    }

    /* File Attachment / Preview Area */

    .file-preview-container {
        width: 100%;
        display: flex; 
        flex-direction: column;
        align-items: flex-start;
        padding: 0 0.5rem 0.5rem 0.5rem; /* Padding before input starts */
        flex-shrink: 0; 
    }

    .file-preview {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem 0;
        width: 100%;
        border-top: 1px solid var(--border-subtle);
        margin-top: 0.5rem;
    }

    .file-pill {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: var(--glass-elevated);
        border: 1px solid var(--accent-cyan);
        border-radius: 20px;
        font-size: 0.875rem;
        color: var(--text-glow);
    }

    .remove-file-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
        transition: color 0.2s;
    }

    .remove-file-btn:hover {
        color: var(--accent-magenta);
    }

    /* ------------------------------------------------------------------- */
    /* --- MOBILE RESPONSIVENESS FIXES (FOR BOTH MOBILE & LAPTOP) --- */
    /* ------------------------------------------------------------------- */

    @media (max-width: 768px) {
    /* ------------------------------------------------------------- */
    /* CORE RESPONSIVENESS FIXES (Keep these to prevent horizontal scroll) */
    /* ------------------------------------------------------------- */
    .sidebar {
        transform: translateX(-100%);
        width: 100vw; 
    }
    .sidebar.visible {
        transform: translateX(0);
    }
    .main-content {
        margin-left: 0 !important; 
    }
    .main-content.expanded {
        margin-left: 0;
    }
    .sidebar-hover-zone {
        display: none;
    }
    
    /* ------------------------------------------------------------- */
    /* ALIGNMENT & VISIBILITY CHANGES (To match the desired UI) */
    /* ------------------------------------------------------------- */
    
    /* HEADER CHANGES: Minimize elements for a clean top bar */
    .main-header {
        padding: 0.75rem 1.25rem; /* Reduced padding */
    }
    
    /* Hide the large model selector and complex side info, keeping only the menu/profile */
    .model-selector {
        display: none;
    }
    
    /* FOOTER CHANGES: Remove helper text/stats and center input */
    .chat-footer {
        padding: 1rem 1.25rem;
    }
    
    /* Hide the entire footer info bar (note and stats) */
    .footer-info {
        display: none;
    }
    
    /* Ensure the input wrapper centers the input container */
    .input-wrapper {
        align-items: center;
        max-width: 600px; /* Center the input container within the footer */
    }
    
    /* Input field alignment tweak for the mobile view */
    .input-container {
        /* Revert to horizontal flex flow for the input row on mobile */
        flex-direction: row; 
        align-items: flex-end;
        
        /* Center the input area by giving it max-width */
        max-width: 95vw; 
        
        /* Reduce gap padding to bring icons closer to text */
        gap: 0.5rem; 
        
        /* Center the "Ask me anything..." text slightly */
        padding: 0.75rem 0.75rem 0.75rem 1rem;
    }

    /* CHAT BUBBLE CHANGES: Clean up user message headers */
    /* Hide the Avatar and time stamp in the User Message header to match minimal style */
    .chat-message.user-message .message-header {
        display: none; 
    }

    /* Move User message bubble closer to the left edge since the avatar is gone */
    .chat-message.user-message .message-content {
        margin-left: 0;
        margin-top: 0.5rem; /* Reduce vertical space after the system message header */
    }

    /* Ensure Gemini avatar and text remain visible */
    .chat-message.gemini-message .message-header {
        display: flex;
    }
}
</style>
</head>
<body>
    <div class="particle" style="left: 5%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 15%; animation-delay: 3s;"></div>
    <div class="particle" style="left: 25%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 35%; animation-delay: 1s;"></div>
    <div class="particle" style="left: 45%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 55%; animation-delay: 7s;"></div>
    <div class="particle" style="left: 65%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 75%; animation-delay: 5s;"></div>
    <div class="particle" style="left: 85%; animation-delay: 8s;"></div>

    <div class="modal" id="apiModal">
        <div class="modal-content">
            <h3>ðŸ”‘ Configure API</h3>
            <p>Enter your Google Gemini API key to start chatting. Get your free key at <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: var(--accent-cyan);">Google AI Studio</a></p>
            
            <input type="password" class="api-input" id="apiKeyInput" placeholder="Enter your Gemini API key...">
            
            <div id="errorContainer"></div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="skipBtn">Skip for now</button>
                <button class="modal-btn modal-btn-primary" id="saveApiKey">Save & Continue</button>
            </div>
        </div>
    </div>

    <div class="sidebar-hover-zone" id="sidebarHoverZone"></div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">âœ¦</div>
                    <div class="logo">NOVA AI</div>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <button class="new-chat-btn" id="newChatBtn" aria-label="Start new chat">
                <svg class="icon" viewBox="0 0 24 24">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>New Conversation</span>
            </button>

            <div class="search-container">
                <svg class="icon search-icon" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" class="search-input" placeholder="Search conversations..." aria-label="Search conversations">
            </div>

            <div class="chat-tabs">
                <button class="chat-tab active">All</button>
                <button class="chat-tab">Starred</button>
                <button class="chat-tab">Recent</button>
            </div>
            
            <div class="sidebar-content">
                <div class="chat-history">
                    <p>Today</p>
                    <ul role="list" id="chatHistoryList"></ul>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <a href="#" tabindex="0" id="settingsBtn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6"></path>
                    </svg>
                    API Settings
                </a>
                <a href="#" tabindex="0">
                    <svg class="icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Help & Support
                </a>
            </div>
        </aside>

        <main class="main-content" id="mainContent" role="main">
            <header class="main-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                        <svg class="icon" viewBox="0 0 24 24">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div class="model-selector" id="modelSelector" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-label="Change AI model">
                        <div id="currentModelBadge" class="model-badge">PRO</div>
                        <span id="currentModelName" class="model-name">Gemini Pro</span>
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        <div class="model-dropdown" id="modelDropdown" role="menu">
                            </div>
                    </div>
                </div>
                <div class="user-profile" tabindex="0" role="button" aria-label="User profile">
                    <div class="user-info">
                        <div class="user-name"></div>
                        <div class="user-status">
                            <div class="status-dot"></div>
                            <span>Online</span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="chat-container" id="chat-container" role="log" aria-live="polite" aria-label="Chat messages">
                </div>

            <footer class="chat-footer">
                <div class="input-wrapper">
                    <form class="input-container" id="chat-form" aria-label="Message input">
    
    <input 
        type="file" 
        id="file-input" 
        accept="image/jpeg,image/png,image/gif,.pdf,.csv" 
        style="display: none;" 
    />
    <div class="file-preview-container" id="filePreviewContainer" style="display: none;">
        <div class="file-preview" id="filePreview"></div>
    </div>
    
    <div style="display: flex; width: 100%; align-items: flex-end; gap: 0.75rem;">
        
        <textarea
            id="user-input"
            placeholder="Ask me anything..."
            aria-label="Message input field"
            rows="1"
            autocomplete="off"
            style="display: block; flex-grow: 1;" 
        ></textarea>

        <div class="voice-visualizer" id="voiceVisualizer" style="display: none; flex-grow: 1;">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
        </div>

        <div class="input-actions" style="flex-shrink: 0;">
            <button type="button" class="icon-btn" id="attachFileBtn" aria-label="Attach file">
                <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </button>
            <button type="button" class="icon-btn" id="voiceBtn" aria-label="Voice input">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
            </button>
            <button type="submit" class="send-btn" id="send-btn" aria-label="Send message">
                <svg class="icon" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>
</form>
                    <div class="footer-info">
                        <div class="footer-note">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 14px; height: 14px;">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            Nova AI may display inaccurate info. Please verify important information.
                        </div>
                        <div class="footer-stats">
                            <span>
                                <svg class="icon" viewBox="0 0 24 24" style="width: 14px; height: 14px;">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                </svg>
                                Fast response
                            </span>
                            <span id="apiStatus">
                                <svg class="icon" viewBox="0 0 24 24" style="width: 14px; height: 14px;">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                </svg>
                                API Ready
                            </span>
                        </div>
                    </div>
                </div>
            </footer>
        </main>
    </div>
   <script>
    // ========================
    // MODEL DATA & CONFIG
    // ========================
    const MODELS = [
        {Â 
            id: 'gemini-2.5-pro',
            name: 'Gemini 2.5 Pro',Â 
            badge: 'PRO',Â 
            badgeClass: 'badge-pro',
            description: 'The most powerful model, designed for complex reasoning and advanced tasks.'
        },
        {Â 
            id: 'gemini-2.5-flash',
            name: 'Gemini 2.5 Flash',Â 
            badge: 'FLASH',
            badgeClass: 'badge-flash',
            description: 'A balanced model offering good performance and a large context window.'
        },
        {Â 
            id: 'gemini-2.5-flash',Â 
            name: 'Gemini 2.5 Flash-Lite',Â 
            badge: 'LITE',
            badgeClass: 'badge-lite',
            description: 'A cost-efficient and fast model optimized for high-frequency tasks.'
        },
        {Â 
            id: 'gemini-2.5-flash', 
            name: 'Gemini 2.5 Flash Image',Â 
            badge: 'IMG',
            badgeClass: 'badge-img',
            description: 'Upgraded for creative workflows with image recognition.'
        },
        {Â 
            id: 'gemini-2.5-flash',
            name: 'Gemini 2.5 Flash Live',Â 
            badge: 'LIVE',
            badgeClass: 'badge-live',
            description: 'Upgraded for real-time, conversational experiences (text-only in this app).'
        },
        {Â 
            id: 'gemini-2.5-flash',
            name: 'Gemini 2.5 Native Audio',Â 
            badge: 'AUDIO',
            badgeClass: 'badge-audio',
            description: 'Supports thinking capabilities with dynamic thinking (text-only in this app).'
        }
    ];

    let currentModel = MODELS[0];
    
    // API CONFIG will be updated dynamically
    let API_CONFIG = {
        endpoint: `https://generativelanguage.googleapis.com/v1beta/models/${currentModel.id}:generateContent`,
        name: currentModel.name
    };

    let apiKey = localStorage.getItem('gemini_api_key') || '';
    let conversationHistory = [];
    
    // NEW VARIABLES
    let isVoiceActive = false;
    let attachedImage = null; // Stores { mimeType: string, data: base64_string, filename: string }

    // Initialize Web Speech API components
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US'; // Set desired language
    }


    // ========================
    // DOM ELEMENTS
    // ========================
    const elements = {
        userInput: document.getElementById('user-input'),
        sendBtn: document.getElementById('send-btn'),
        chatContainer: document.getElementById('chat-container'),
        chatForm: document.getElementById('chat-form'),
        apiModal: document.getElementById('apiModal'),
        apiKeyInput: document.getElementById('apiKeyInput'),
        saveApiKeyBtn: document.getElementById('saveApiKey'),
        skipBtn: document.getElementById('skipBtn'),
        settingsBtn: document.getElementById('settingsBtn'),
        newChatBtn: document.getElementById('newChatBtn'),
        errorContainer: document.getElementById('errorContainer'),
        sidebar: document.getElementById('sidebar'),
        mainContent: document.getElementById('mainContent'),
        sidebarToggle: document.getElementById('sidebarToggle'),
        menuToggle: document.getElementById('menuToggle'),
        sidebarHoverZone: document.getElementById('sidebarHoverZone'),
        modelSelector: document.getElementById('modelSelector'),
        modelDropdown: document.getElementById('modelDropdown'),
        currentModelName: document.getElementById('currentModelName'),
        currentModelBadge: document.getElementById('currentModelBadge'),
        apiStatus: document.getElementById('apiStatus'),
        
        // NEW ELEMENTS FOR INPUT CONTROLS
        attachFileBtn: document.getElementById('attachFileBtn'),
        fileInput: document.getElementById('file-input'),
        filePreview: document.getElementById('filePreview'),
        filePreviewContainer: document.getElementById('filePreviewContainer'), 
        voiceBtn: document.getElementById('voiceBtn'),
        voiceVisualizer: document.getElementById('voiceVisualizer'),
        chatInputContainer: document.getElementById('chat-form') 
    };

    // ========================
    // AUTO-HIDE SIDEBAR
    // ========================
    let sidebarTimeout;
    let isSidebarPinned = false;
    function showSidebar() { elements.sidebar.classList.remove('hidden'); elements.mainContent.classList.remove('expanded'); }
    function hideSidebar() { if (!isSidebarPinned) { elements.sidebar.classList.add('hidden'); elements.mainContent.classList.add('expanded'); } }
    function toggleSidebarPin() { isSidebarPinned = !isSidebarPinned; elements.sidebarToggle.style.transform = isSidebarPinned ? 'rotate(90deg)' : 'rotate(0deg)'; if (isSidebarPinned) showSidebar(); }
    elements.sidebarHoverZone.addEventListener('mouseenter', () => { clearTimeout(sidebarTimeout); showSidebar(); });
    elements.sidebar.addEventListener('mouseleave', () => { if (!isSidebarPinned) sidebarTimeout = setTimeout(hideSidebar, 300); });
    elements.sidebar.addEventListener('mouseenter', () => clearTimeout(sidebarTimeout));
    elements.sidebarToggle.addEventListener('click', toggleSidebarPin);
    elements.menuToggle.addEventListener('click', () => {
        if (window.innerWidth <= 768) { elements.sidebar.classList.toggle('visible'); }Â 
        else if (elements.sidebar.classList.contains('hidden')) { isSidebarPinned = true; showSidebar(); }Â 
        else { isSidebarPinned = false; hideSidebar(); }
    });
    if (window.innerWidth > 768) { setTimeout(hideSidebar, 1500); }
     else {
    // Ensure sidebar starts hidden on mobile (critical fix)
    elements.sidebar.classList.add('hidden');
    elements.mainContent.classList.remove('expanded');
    }

    // ========================
    // INITIALIZATION
    // ========================
    document.addEventListener('DOMContentLoaded', () => {
        if (!apiKey) {
            elements.apiModal.classList.add('active');
        }
        populateModelDropdown();
        updateModelDisplay();
        startNewChat();
        addEventListeners();
    });

    function addEventListeners() {
        elements.userInput.addEventListener('input', () => {
            elements.userInput.style.height = 'auto';
            elements.userInput.style.height = `${elements.userInput.scrollHeight}px`;
        });

        elements.chatForm.addEventListener('submit', handleChat);
        elements.saveApiKeyBtn.addEventListener('click', saveApiKey);
        elements.skipBtn.addEventListener('click', () => elements.apiModal.classList.remove('active'));
        elements.settingsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            elements.apiModal.classList.add('active');
            elements.apiKeyInput.value = apiKey;
        });
        elements.newChatBtn.addEventListener('click', startNewChat);

        elements.userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleChat(event);
            }
        });

        elements.chatContainer.addEventListener('click', handleChatContainerClick);
        elements.modelSelector.addEventListener('click', toggleModelDropdown);
        
        // NEW FEATURE LISTENERS
        elements.attachFileBtn.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileAttachment);
        elements.voiceBtn.addEventListener('click', toggleVoiceMode);
        
        // Web Speech API Listeners
        if (recognition) {
            recognition.onresult = handleSpeechResult;
            recognition.onerror = handleSpeechError;
            recognition.onend = handleSpeechEnd;
        }
    }
    
    // ========================
    // MODEL SELECTOR LOGIC
    // ========================
    function populateModelDropdown() {
        elements.modelDropdown.innerHTML = '';
        MODELS.forEach(model => {
            const option = document.createElement('div');
            option.classList.add('model-option');
            option.dataset.modelId = model.id; 
            option.setAttribute('role', 'menuitem');
            option.innerHTML = `
                <div class="model-option-title">
                    <div class="model-badge ${model.badgeClass}">${model.badge}</div>
                    <span class="model-name">${model.name}</span>
                </div>
                <p>${model.description}</p>
            `;

            option.addEventListener('click', (e) => {
                e.stopPropagation();
                const selectedModelId = e.currentTarget.dataset.modelId;
                const selectedModel = MODELS.find(m => m.id === selectedModelId && m.name === e.currentTarget.querySelector('.model-name').textContent);

                if (selectedModel) {
                    currentModel = selectedModel;
                    updateModelDisplay();
                    toggleModelDropdown();
                    startNewChat();
                }
            });
            elements.modelDropdown.appendChild(option);
        });
    }

    function toggleModelDropdown() {
        const isExpanded = elements.modelSelector.getAttribute('aria-expanded') === 'true';
        elements.modelDropdown.classList.toggle('visible');
        elements.modelSelector.setAttribute('aria-expanded', !isExpanded);
    }
    
    function updateModelDisplay() {
        API_CONFIG.endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel.id}:generateContent`;
        API_CONFIG.name = currentModel.name;
        elements.currentModelName.textContent = currentModel.name;
        elements.currentModelBadge.textContent = currentModel.badge;
        elements.currentModelBadge.className = `model-badge ${currentModel.badgeClass}`;
        elements.apiStatus.innerHTML = `
            <svg class="icon" viewBox="0 0 24 24" style="width: 14px; height: 14px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
            ${currentModel.name} Ready
        `;
    }
    
    // ========================
    // API KEY & CHAT MANAGEMENT
    // ========================
    function saveApiKey() {
        const key = elements.apiKeyInput.value.trim();
        if (!key) return showError('Please enter a valid API key');
        apiKey = key;
        localStorage.setItem('gemini_api_key', key);
        elements.apiModal.classList.remove('active');
        elements.errorContainer.innerHTML = '';
        updateModelDisplay();
    }

    function startNewChat() {
        conversationHistory = [];
        elements.chatContainer.innerHTML = `<div class="chat-message welcome-message"><h1>Hello from ${currentModel.name},</h1><h2>How can I assist you today?</h2><div class="suggestion-cards"><div class="suggestion-card" data-prompt="Tell me about research assistance"><div class="suggestion-icon">ðŸ”</div><div class="suggestion-title">Research Assistant</div><div class="suggestion-desc">Get detailed information on any topic</div></div><div class="suggestion-card" data-prompt="Help me brainstorm creative ideas"><div class="suggestion-icon">ðŸ’¡</div><div class="suggestion-title">Creative Ideas</div><div class="suggestion-desc">Brainstorm innovative solutions</div></div><div class="suggestion-card" data-prompt="Help me write compelling content"><div class="suggestion-icon">ðŸ“</div><div class="suggestion-title">Writing Help</div><div class="suggestion-desc">Craft compelling content</div></div><div class="suggestion-card" data-prompt="Help me solve a coding problem"><div class="suggestion-icon">ðŸ§®</div><div class="suggestion-title">Code & Math</div><div class="suggestion-desc">Solve complex problems</div></div></div></div>`;
        document.querySelectorAll('.suggestion-card').forEach(card => card.addEventListener('click', () => {
            elements.userInput.value = card.dataset.prompt;
            elements.userInput.focus();
        }));
    }

    /* --- UPDATED handleChat FUNCTION --- */
    async function handleChat(e) {
        e.preventDefault();
        const userMessage = elements.userInput.value.trim();
        if (!userMessage && !attachedImage) return;

        if (!apiKey) {
            elements.apiModal.classList.add('active');
            return showError('Please configure your API key first');
        }

        elements.sendBtn.disabled = true;

        const welcomeMessage = elements.chatContainer.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => welcomeMessage.remove(), 300);
        }
        
        // 1. Prepare user content (message + optional image)
        const userContent = { role: 'user', content: userMessage };
        if (attachedImage) {
            userContent.attachedFile = attachedImage;
        }
        
        // 2. Display user message immediately
        const displayMessage = userMessage || `[File Attached: ${attachedImage.filename}]`;
        appendMessage(displayMessage, 'user', attachedImage ? `data:${attachedImage.mimeType};base64,${attachedImage.data}` : null); 
        
        // 3. Clear inputs and loading state for next message
        elements.userInput.value = '';
        elements.userInput.style.height = 'auto';
        removeFileAttachment();

        showLoading();

        try {
            // 4. Send the API request
            const response = await callGeminiAPI(userContent);
            removeLoading();
            
            // 5. Handle response and update history
            if (response.type === 'image') {
                appendMessage(response.text, 'gemini', response.image); 
            } else {
                appendMessage(response.text, 'gemini');
            }
            
            conversationHistory.push(userContent, { role: 'assistant', content: response.text });
            
        } catch (error) {
            removeLoading();
            appendMessage(`**Error:** ${error.message}. Please check your API key and permissions for the '${currentModel.name}' model.`, 'gemini');
            console.error('API Error:', error);
        }

        elements.sendBtn.disabled = false;
        elements.userInput.focus();
    }

    /* --- callGeminiAPI FUNCTION (Multimodal Support) --- */
    async function callGeminiAPI(userContent) {
        const url = `${API_CONFIG.endpoint}?key=${apiKey}`;

        const historyPayload = conversationHistory.map(item => {
            let parts = [];
            if (item.content) {
                parts.push({ text: item.content });
            }
            if (item.attachedFile) {
                parts.push({
                    inlineData: {
                        data: item.attachedFile.data,
                        mimeType: item.attachedFile.mimeType
                    }
                });
            }
            return {
                role: item.role === 'assistant' ? 'model' : 'user',
                parts: parts
            };
        });

        // Build the current message parts
        let currentMessageParts = [];
        if (userContent.content) {
            currentMessageParts.push({ text: userContent.content });
        }
        if (userContent.attachedFile) {
            currentMessageParts.push({
                inlineData: {
                    data: userContent.attachedFile.data,
                    mimeType: userContent.attachedFile.mimeType
                }
            });
        }
        
        if (currentMessageParts.length === 0) {
             throw new Error("Cannot send empty prompt.");
        }

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [...historyPayload, { role: 'user', parts: currentMessageParts }]
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || `API request failed: ${response.status}`);
        }

        const data = await response.json();
        
        const parts = data.candidates?.[0]?.content?.parts;
        if (parts && parts.length > 0) {
            const firstPart = parts[0];
            if (firstPart.inlineData?.mimeType && firstPart.inlineData.data) {
                return {
                    type: 'image',
                    text: firstPart.text || 'Here is your file analysis:',
                    image: `data:${firstPart.inlineData.mimeType};base64,${firstPart.inlineData.data}`
                };
            } else if (firstPart.text) {
                return {
                    type: 'text',
                    text: firstPart.text
                };
            }
        }
        
        throw new Error('Invalid or empty response from API');
    }
    
    // =========================================================
    // VOICE RECOGNITION AND FILE HANDLER FUNCTIONS
    // =========================================================
    
    /* --- Web Speech API Handlers --- */

    function handleSpeechResult(event) {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                transcript += event.results[i][0].transcript;
            }
        }
        
        if (transcript) {
            // 1. Fill the textarea with the result
            elements.userInput.value = transcript;
            
            // 2. Hide the visualizer and restore the text mode UI
            isVoiceActive = false;
            elements.userInput.style.display = 'block';
            elements.voiceVisualizer.style.display = 'none';
            elements.chatInputContainer.classList.remove('voice-active');
            elements.voiceBtn.classList.remove('active');
            elements.sendBtn.disabled = false;
            elements.userInput.placeholder = 'Ask me anything...';
            
            // 3. Auto-submit the recognized text
            const submitEvent = { preventDefault: () => {}, target: elements.chatForm }; 
            handleChat(submitEvent);
        }
    }

    function handleSpeechError(event) {
        if (event.error !== 'no-speech') {
            showError(`Voice Recognition Error: ${event.error}. Try granting microphone access.`);
        }
        // Ensure UI is reset on error
        handleSpeechEnd();
    }

    function handleSpeechEnd() {
        // Only run reset if we didn't already transition to text mode
        if (isVoiceActive) {
            isVoiceActive = false;
            elements.userInput.style.display = 'block';
            elements.voiceVisualizer.style.display = 'none';
            elements.chatInputContainer.classList.remove('voice-active');
            elements.voiceBtn.classList.remove('active');
            elements.sendBtn.disabled = false;
            elements.userInput.placeholder = 'Ask me anything...';
        }
    }


    /* --- Voice Mode Toggle Logic --- */
    function toggleVoiceMode() {
        if (!SpeechRecognition) {
             return showError('Web Speech API not supported in this browser.');
        }

        elements.userInput.style.height = 'auto'; 

        if (!isVoiceActive) {
            // State 1: Start Recording
            isVoiceActive = true;
            
            elements.userInput.style.display = 'none';
            elements.voiceVisualizer.style.display = 'flex';
            elements.chatInputContainer.classList.add('voice-active');
            elements.voiceBtn.classList.add('active');
            elements.sendBtn.disabled = true;
            elements.userInput.value = ''; 
            elements.userInput.placeholder = 'Listening...';
            
            // Start Speech Recognition
            try {
                recognition.start();
            } catch (e) {
                 // May throw error if already started or permission denied
                 showError("Failed to start mic. Check permissions.");
                 handleSpeechEnd(); // Reset UI
            }

        } else {
            // State 2: Stop Recording (User clicked again)
            isVoiceActive = false;
            recognition.stop();
            // The UI reset is handled by handleSpeechEnd or handleSpeechResult/Error
        }
    }

    /* --- File Attachment/Multimodal Logic --- */
    window.removeFileAttachment = removeFileAttachment; 

    function handleFileAttachment(event) {
        const file = event.target.files[0];
        if (!file) return;

        const MAX_SIZE = 5 * 1024 * 1024; // 5 MB limit
        const fileType = file.type;

        if (file.size > MAX_SIZE) {
            return showError(`File size exceeds the 5MB limit. Your file is ${Math.round(file.size / 1024 / 1024)} MB.`);
        }

        if (!fileType.startsWith('image/') && fileType !== 'application/pdf' && fileType !== 'text/csv') {
            return showError('Unsupported file type. Please upload an image, PDF, or CSV.');
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const base64Data = e.target.result.split(',')[1];
            
            attachedImage = { 
                mimeType: file.type,
                data: base64Data,
                filename: file.name
            };
            updateFilePreview(file.name);
        };
        reader.readAsDataURL(file);
    }

    function updateFilePreview(filename) {
        let iconSvg;
        const lowerFilename = filename.toLowerCase();

        if (lowerFilename.endsWith('.pdf')) {
            iconSvg = '<svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--accent-magenta); stroke: none;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>';
        } else if (lowerFilename.endsWith('.csv')) {
            iconSvg = '<svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--success-green); stroke: none;"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><path d="M9 16l3-3 3 3"></path><path d="M9 8l3 3 3-3"></path></svg>';
        } else {
            iconSvg = '<svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: var(--accent-cyan); fill: none;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>';
        }

        elements.filePreview.innerHTML = `
            <div class="file-pill">
                ${iconSvg}
                <span>${filename}</span>
                <button type="button" class="remove-file-btn" aria-label="Remove file" onclick="removeFileAttachment()">
                    <svg class="icon" viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke-width: 3;">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        `;
        elements.filePreviewContainer.style.display = 'flex';
    }

    function removeFileAttachment() {
        attachedImage = null;
        elements.fileInput.value = ''; 
        elements.filePreview.innerHTML = '';
        elements.filePreviewContainer.style.display = 'none';
    }


    /* --- UI & UTILITY FUNCTIONS (Kept for completeness) --- */
    /* --- REVISED appendMessage FUNCTION --- */
function appendMessage(message, sender, imageData = null) { 
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('chat-message', `${sender}-message`);
    messageWrapper.setAttribute('role', 'article');

    const header = document.createElement('div');
    header.classList.add('message-header');

    const content = document.createElement('div');
    content.classList.add('message-content');
    
    // Add image if imageData is provided
    if (imageData) {
        const imgElement = document.createElement('img');
        imgElement.src = imageData;
        imgElement.alt = "Generated Image";
        imgElement.classList.add('generated-image');
        content.appendChild(imgElement);
    }
    content.innerHTML += formatMessage(message); // Append text content

    const senderName = sender === 'gemini' ? currentModel.name : 'You';
    const avatarIcon = sender === 'gemini'
        ? '<svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: white;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>'
        : '<svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: white;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';

    // --- NEW ACTIONS PANEL CONSTRUCTION ---
    let panelActionsHTML = `
        <button class="action-btn copy-btn" aria-label="Copy message">
            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
    `;

    if (sender === 'gemini') {
        // Only Gemini messages get the TTS and feedback buttons
        panelActionsHTML += `
            <button class="action-btn tts-btn" aria-label="Read aloud">
                <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            </button>
            <button class="action-btn like-btn" aria-label="Like response">
                <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
            </button>
            <button class="action-btn dislike-btn" aria-label="Dislike response">
                <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zM7 2H4a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h3"></path></svg>
            </button>
        `;
    }

    // Insert the actions panel HTML directly into the message content container
    const actionsPanel = `<div class="message-actions-panel">${panelActionsHTML}</div>`;
    content.innerHTML += actionsPanel;


    // Construct the header (without any action buttons)
    header.innerHTML = `<div class="message-avatar">${avatarIcon}</div><span class="message-name">${senderName}</span><span class="message-time">Just now</span>`;

    // Append the header and content
    messageWrapper.appendChild(header);
    messageWrapper.appendChild(content);
    elements.chatContainer.appendChild(messageWrapper);
    elements.chatContainer.scrollTo({ top: elements.chatContainer.scrollHeight, behavior: 'smooth' });
}

    function formatMessage(text) {
        let safeText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        safeText = safeText.replace(/```(\w*)\n([\s\S]+?)```/g, (match, lang, code) => {
            const escapedCode = code.replace(/</g, '&lt;').replace(/&gt;/g, '&gt;').trim();
            return `<div class="code-block"><button class="copy-code-btn" aria-label="Copy code">Copy</button><pre><code class="language-${lang || 'plaintext'}">${escapedCode}</code></pre></div>`;
        });
        safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        safeText = safeText.replace(/\*(.*?)\*/g, '<em>$1</em>');
        safeText = safeText.replace(/`([^`]+)`/g, '<code>$1</code>');
        const lines = safeText.split('\n');
        let html = '';
        let inList = null;
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const ulMatch = line.match(/^(\s*)\*\s+(.*)/);
            const olMatch = line.match(/^(\s*)\d+\.\s+(.*)/);
            if (ulMatch) {
                if (inList !== 'ul') { if (inList) html += `</${inList}>`; html += '<ul>'; inList = 'ul'; }
                html += `<li>${ulMatch[2]}</li>`;
            } else if (olMatch) {
                if (inList !== 'ol') { if (inList) html += `</${inList}>`; html += '<ol>'; inList = 'ol'; }
                html += `<li>${olMatch[2]}</li>`;
            } else {
                if (inList) { html += `</${inList}>`; inList = null; }
                if (line.trim().startsWith('&lt;div class="code-block"&gt;')) {
                    html += line.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                } else if (line.trim() !== '') { html += `<p>${line}</p>`; }
            }
        }
        if (inList) html += `</${inList}>`;
        return html.replace(/<p><\/p>/g, '');
    }

    function showLoading() {
        const loadingWrapper = document.createElement('div');
        loadingWrapper.classList.add('chat-message', 'gemini-message', 'loading-message');
        loadingWrapper.innerHTML = `<div class="message-header"><div class="message-avatar"><svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: white;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg></div><span class="message-name">${currentModel.name}</span><span class="message-time">Typing...</span></div><div class="message-content loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>`;
        elements.chatContainer.appendChild(loadingWrapper);
        elements.chatContainer.scrollTo({ top: elements.chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function removeLoading() {
        const loadingMessage = elements.chatContainer.querySelector('.loading-message');
        if (loadingMessage) loadingMessage.remove();
    }

    function showError(message) {
        elements.errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        setTimeout(() => { elements.errorContainer.innerHTML = ''; }, 5000);
    }

    function handleChatContainerClick(e) {
        const button = e.target.closest('button');
        if (!button) return;
        if (button.classList.contains('copy-btn')) handleMessageCopy(button);
        if (button.classList.contains('copy-code-btn')) handleCodeCopy(button);
        if (button.classList.contains('tts-btn')) handleTTS(button);
        if (button.classList.contains('like-btn')) handleFeedback(button);
        if (button.classList.contains('dislike-btn')) handleFeedback(button);
    }
    function handleMessageCopy(button) {
        const messageContent = button.closest('.chat-message').querySelector('.message-content');
        // If there's an image, copy only the text content
        const textToCopy = messageContent.querySelector('img') ? messageContent.textContent : messageContent.innerText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            button.innerHTML = '<svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            setTimeout(() => {
                button.innerHTML = '<svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
            }, 2000);
        });
    }
    function handleCodeCopy(button) {
        const codeEl = button.closest('.code-block').querySelector('code');
        navigator.clipboard.writeText(codeEl.innerText).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => { button.textContent = 'Copy'; }, 2000);
        });
    }
    function handleTTS(button) {
        const messageContent = button.closest('.chat-message').querySelector('.message-content');
        // If there's an image, read only the text content
        const textToSpeak = messageContent.querySelector('img') ? messageContent.textContent : messageContent.innerText;
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
        } else {
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            speechSynthesis.speak(utterance);
        }
    }
    function handleFeedback(button) {
        const parentActions = button.parentElement;
        const likeBtn = parentActions.querySelector('.like-btn');
        const dislikeBtn = parentActions.querySelector('.dislike-btn');
        if (button.classList.contains('active')) {
            button.classList.remove('active');
        } else {
            likeBtn.classList.remove('active');
            dislikeBtn.classList.remove('active');
            button.classList.add('active');
        }
    }
</script>
</body>
</html>
